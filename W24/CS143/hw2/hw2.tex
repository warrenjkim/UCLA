\documentclass{report}
\usepackage{enumitem}
\usepackage{amsmath}
\usepackage{booktabs}
\usepackage{mathtools}
\usepackage{fancyhdr}
\usepackage{tikz}
\usepackage{xcolor}
\usepackage{listings}
\usepackage{mdframed}
\usepackage{upquote}
\usepackage{changepage}
\usetikzlibrary{calc,positioning,shapes.multipart,shapes}
\usepackage[margin=1in]{geometry}

\renewcommand{\it}[1]{\textit{{#1}}}
\renewcommand{\bf}[1]{\textbf{{#1}}}
\renewcommand{\tt}[1]{\texttt{{#1}}}

\newcommand{\ib}[1]{\it{\bf{{#1}}}}

\newmdenv[
topline=true,
bottomline=true,
leftline=true,
rightline=true,
skipabove=\medskipamount,
skipbelow=\medskipamount
]{responseframe}
\newenvironment{response}{\begin{responseframe}\vspace{-10pt}\paragraph{Response:}}{\end{responseframe}}

\pagestyle{fancy}
\fancyhf{}

\fancyhead[L]{\bf{Computer Science 143}}
\fancyhead[C]{\it{Homework 2}}
\fancyhead[R]{\bf{Warren Kim}}
\setlength{\headsep}{0.1in}

\tikzset{
    basic/.style={
        draw,
        rectangle split,
        rectangle split parts=2,
        rectangle split part fill={blue!20,white},
        minimum width=2.5cm,
        text width=2cm,
        align=left,
        font=\itshape
    }
}

\begin{document}
\paragraph{Part 1. Relational Algebra}\mbox{} \vspace{10pt}
In this problem, you will use a few relations representing some fictitious Southwest Airlines 
flights and airplanes. Use only this instance. \tt{flights} contains information about flight 
routes on a particular day, departure time and the exact aircraft (\tt{tail}) used to fly that 
particular flight. aircraft contains information about all airplanes that Southwest owns and 
operates. A smaller relation, \tt{airtran\_aircraft} contains information about airplanes that 
Southwest acquired in its purchase of Airtran in 2011. Tuples in \tt{airtran\_aircraft} also 
appear in \tt{aircraft} if they were acquired by Southwest. [If curious, the aircraft types are 
described as B73G (Boeing 737-700), B738 (Boeing 737-800) and B38M (Boeing 737 MAX 8, or 737-8).]

\begin{table}[ht]
    \begin{tabular}{c|c|c|c|c}
        \hline
        \tt{from} & \tt{to} & \tt{flightnum} & \tt{departure} & \tt{tail} \\
        \hline
        LAX & SFO & 181 & 8am & N8751R \\
        LAX & SJC & 185 & 9am & N705SW \\
        SJC & LAX & 186 & 10am & N404WN \\
        BUR & SJC & 191 & 11am & N957WN \\
        LAX & ATL & 993 & 12pm & N7851A \\
        MCO & CUN & 991 & 1pm & N7827A \\
        SJC & BUR & 192 & 2pm & N709SW \\
        SFO & LAX & 182 & 3pm & N8751R \\
        SJC & DAL & 94 & 4pm & N705SW \\
        SJC & PHX & 99 & 5pm & N957WN 
    \end{tabular}
    \hfill
    \begin{tabular}{c|c}
        \hline
        \tt{tail} & \tt{type} \\
        \hline
        N404WN & B73G \\
        N705SW & B73G \\
        N709SW & B73G \\
        N8751R & B73G \\
        N7851A & B38M \\
        N7827A & B73G \\
        N7854B & B73G \\
        N7826B & B73G \\
        N957WN & B738 
    \end{tabular}
    \hfill
    \begin{tabular}{c|c}
        \hline
        \tt{tail} & \tt{type} \\
        \hline
        N7851A & B73G \\
        N7827A & B73G \\
        N7854B & B73G \\
        N7826B & B73G
    \end{tabular}
\end{table}
\paragraph{Exercises.}
\begin{enumerate}[label=(\alph*)]
    \item Write a relational algebra expression that returns the number of flights flown by each 
        \tt{type} of aircraft. A flight is uniquely identified by its flight number (denoted 
        \tt{flightnum}). Each flight number is used for one take off and one landing. Your result 
        should provide insight like ``4 flights were flown by an airplane that is of type B738.'' 
        \tt{flightnum} is a flight number (i.e. Southwest flight 181) and not the number of flights 
        flown.
                \begin{response}
                    \begin{align*}
                        \prescript{}{\tt{type}}{\gamma}_{\tt{COUNT}(\tt{flightnum}) \to \tt{count}}
                        (
                    &\tt{flights} \bowtie \tt{aircraft}
                    )
                    \end{align*}
                \end{response}
    \item In 2011, Southwest Airlines acquired Airtran. The relation \tt{aircraft} contains 
        Southwest owns, including those acquired from Airtran. The relation \tt{airtran\_aircraft} 
        includes information about \emph{only} Airtranâ€™s aircraft. Write a relational algebra 
        expression that returns all flight numbers (\tt{flightnum}) operated by aircraft that were 
        \emph{not} operated by Airtran.
        \begin{response}
            \begin{align*}
                \Pi_{\tt{flightnum}}
                (
                &\tt{flights} \bowtie [\tt{aircraft - airtran\_aircraft}]
                )
            \end{align*}
        \end{response}
    \item Most aircraft fly multiple routes in one day. For example, tail N705SW flies from LAX 
        (Los Angeles) to SJC (San Jose, CA) and then flies from SJC (San Jose) to DAL (Dallas). 
        Such schedules form a graph. Write the relational algebra expression that return the tail 
        and where each plane starts and ends up after two flights: tail, origin (\tt{from}), and 
        \tt{final\_destination} (to after 2 flights). In the example earlier, the query would 
        return N705SW, LAX and DAL since it started at LAX and ended up at DAL after two flights. 
        A couple of notes and hints: (1) if a tail only flew one flight, it would not appear in the 
        output, (2) you are essentially traversing a graph, and this is an example of a 
        \emph{self join}, (3) you need to somehow use the departure time and this is an example of 
        a \emph{non-equi-join}. \bf{Be very careful with aliasing and renaming in this problem.}
        \begin{adjustwidth}{-7.7em}{-5.2em}
            \begin{response}
                \begin{align*}
                    &\Pi_{\tt{dest.tail} \to \tt{tail}, \tt{src.from} \to \tt{origin}, \tt{dest.to} \to \tt{final\_destination}} \\
                    &
                    (
                \rho_{\tt{src}}(\tt{flights}) 
                \bowtie_{(\tt{src.tail = dest.tail} 
                \land \tt{dest.from = src.to}
            \land \tt{src.departure < dest.departure})}
                \rho_{\tt{dest}}(\tt{flights})
                )
                \end{align*}
            \end{response}
        \end{adjustwidth}
\end{enumerate}

\paragraph{Part 2. SQL Schemas} \vspace{10pt} 

\bf{Use the Starship food delivery scenario from Homework 1 and look at the schema diagram in the 
solutions. Note that we modify it here slightly.} \vspace{10pt}

\noindent In Homework 1, we created a relational schema and diagram for the Starship example. In
this problem, we will create a SQL schema using the \tt{CREATE TABLE} syntax. This means we also need to
pick the proper data types for each column. For a description of how Starship works, see Homework 1.
\vspace{10pt}


\noindent We need a table to represent a \tt{robot}. Each of the following statements is designed to
give you a hint as to the proper data type.

\begin{enumerate} 
    \item Each robot has an identifier \tt{robot\_id}, a number. Since Starship is a startup, we
        assume that there are no more than 10,000 robots. 
    \item Each robot has a flag \tt{status} that marks it as online, offline (broken etc.), and
        lost/stolen. Each robot can have only one of these states at a time, and must have a state.
\end{enumerate}

\noindent We need a table to represent a \bf{customer} (user is a system keyword so I will not use it):

\begin{enumerate} 
    \item Each user has an identifier \tt{user\_id}, a number, and we assume that Starship has at
        most 500,000 users for now. 
    \item A user is just someone that installed the app,
        not necessarily someone that will use a robot. Thus, they may, or may not have a credit card
        number \tt{ccnum} (exactly 16 digits) and expiration date \tt{expdate}. Expiration dates
        usually look like MM/YY, but to make this simpler so you can use a more apparent data type, it
        is safe to assume that the card expires at midnight (00:00) on the 1st of the month. A credit
        card can only be associated with one user. 
    \item Each user must have an \tt{email} address.
        Assume an email address length is at most 100. An email can only be associated with one user. 
    \item Each user must have a \tt{name}. Assume a name cannot exceed 255 letters. 
\end{enumerate}

\noindent We need a table to represent an \bf{order}. Only once food is placed into the robot do we
enter an order in this table, and its journey begins. Each order is associated with:

\begin{enumerate} 
    \item a unique identifier \tt{order\_id}, a number. We expect there to be more than 50,000
        orders. 
    \item exactly one user \tt{user\_id}, exactly one robot \tt{robot\_id} and exactly one
        restaurant \tt{restaurant\_id}. 
    \item a \tt{start\_time} and \tt{end\_time}, which includes the date. In the event that the
        order is canceled after being dispatched, or the robot fails, there may not be an end time.
    \item a \tt{delivery\_location} as a GPS coordinate (a latitude/longitude pair). \it{Hint:} See
        the documentation here. Note that latitude and longitude together form a point on a
        Cartesian plane (actually a sphere, but we will assume Cartesian plane for this problem). If
        the order is canceled or an error occurs with the robot, there may not be a delivery
        location stored. 
    \item a required order status called \tt{status} that can take on the values \tt{delivered},
        \tt{canceled}, \tt{error}. 
\end{enumerate}

\noindent Finally, we need a table to represent a \bf{restaurant} which contains:

\begin{enumerate} 
    \item a unique identifier for the restaurant \tt{restaurant\_id}. Assume there are currently
        10,000 restaurants. 
    \item the name of the restaurant which contains at most 255 characters. 
    \item a \tt{region\_id} which is a 4 digit alphanumeric code representing the geofenced region.
        For UCLA this could be UCLA or a code like 1919. 
\end{enumerate}

\paragraph{Exercise.} Write the SQL schema for the tables discussed above using \tt{CREATE TABLE}.
Specify a primary key, or composite primary key using the correct syntax. Specify the proper foreign
key relationship on each table (if they exist) using the proper syntax. Try to minimize storage
space because we can always promote later.

\lstdefinestyle{psql}{
  basicstyle=\ttfamily\small,       
  breakatwhitespace=false,          
  keywordstyle=\color{blue},          
  morekeywords={,CREATE, TABLE, TYPE, AS, ENUM, PRIMARY, FOREIGN, KEY, NOT, NULL, UNIQUE,
  REFERENCES, smallint, date, varchar, timestamptz, DEFAULT, CURRENT_TIMESTAMP, point,}
  breaklines=true,                  
  captionpos=b,                     
  keepspaces=true,                  
  showspaces=false,                 
  showstringspaces=false,           
  showtabs=false,                   
  tabsize=2,                        
  frame=single                      
}


\begin{lstlisting}[style=psql]
CREATE TYPE robot_status AS ENUM (
    'online',
    'offline',
    'broken',
    'default'
);

CREATE TABLE robot (
    robot_id smallint NOT NULL UNIQUE,
    status robot_status NOT NULL DEFAULT 'default',
    PRIMARY KEY (robot_id)
);

CREATE TABLE customer (
    user_id int NOT NULL UNIQUE,
    ccnum numeric(16, 0) UNIQUE,
    expdate date,
    email varchar(100) UNIQUE,
    name varchar(255)
    PRIMARY KEY (user_id)
);

CREATE TYPE order_status AS ENUM (
    'in-progress'
    'delivered',
    'canceled',
    'error'
);

CREATE TABLE order (
    order_id int NOT NULL UNIQUE,
    user_id int,
    robot_id smallint,
    restaurant_id smallint,
    start_time timestamptz DEFAULT CURRENT_TIMESTAMP,
    end_time timestamptz,
    delivery_location point,
    status order_status NOT NULL,
    PRIMARY KEY (order_id),
    FOREIGN KEY (user_id) REFERENCES customer (user_id),
    FOREIGN KEY (robot_id) REFERENCES robot (robot_id),
    FOREIGN KEY (restaurant_id) REFERENCES restaurant (restaurant_id)
);

CREATE TABLE restaurant (
    restaurant_id smallint NOT NULL UNIQUE,
    name varchar(255),
    region_id numeric(4, 0) NOT NULL,
    PRIMARY KEY (restaurant_id)
);
\end{lstlisting}
\end{document}
